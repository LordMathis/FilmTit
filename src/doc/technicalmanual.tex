\label{chap:technical_manual}

\todo{shouldnt this be called Installation manual? or Administrators manual?}

\section{System Requirements and Setup}

\subsection{Running the Server}

The system is cross-platform, requiring only Java 1.6 or newer and \postgres~(tested with version 9.1, but should generally work with version >8.3). The system was tested on Windows XP, Windows 7, Mac OS X and Ubuntu.

The system is run from a jar file that contains the full server and all dependencies (the jar file is 108M in size). The server can be run with the following command:

\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={Running the server}}
\begin{lstlisting}
java -jar server-0.1.jar configuration.xml 8080
\end{lstlisting}
\vspace*{0.5em}

The arguments specify the configuration file (see Section~\ref{sec:config}) and the port the server should run on. Although it is not strictly necessary, it is recommended to run the server with a maximum heap size of 500MB ({\tt -Xmx500m}).


\subsection{Database Configuration}

The system will work with any standard \postgres~installation, however it is recommended to setup \postgres~to use more memory to assure the database runs fast. On our production server (with 4GB of memory), we use the following settings:


%TODO: put the actual values here
\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={Production server \postgres~settings}}
\begin{lstlisting}
maintenance_work_mem = 256MB
effective_cache_size = 1500MB
work_mem = 256MB
shared_buffers = 1GB
max_connections = 10
\end{lstlisting}
\vspace*{0.5em}

To use \postgres~with the necessary amount of memory on a Linux system, the kernel settings for shared memory may have to be adjusted, e.g.:

\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={/etc/sysctl.conf on production server}}
\begin{lstlisting}
# Maximum shared segment size in bytes
kernel.shmmax = 2147483648
# Maximum number of shared memory segments in pages
kernel.shmall = 4194304
\end{lstlisting}
\vspace*{0.5em}
\todo{put the real values here!}

For more information on \postgres~memory management and how to adjust the shared memory settings for different operating systems, please see the \postgres~documentation on \emph{Resource Consumption}.\footnote{\url{http://www.postgresql.org/docs/9.1/static/runtime-config-resource.html}}

For the fulltext search the \emph{TSearch2} tool is used. By default few world languages are available. If you want to use the tool for other languages you need to install the language support manually. For the Czech language we prepared an installation script which can run using following command.

\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={Installing Czech to \postgres}}
\begin{lstlisting}
$ ./install_czech_to_postgres.sh <postgres_directory> <postgres_user> <database_name>
\end{lstlisting}
\vspace*{0.5em}




\section{Tasks}

\subsection{Importing Data}

\subsubsection{Alignment}

\todo{!}


\subsubsection{Import}

After all necessary paths are specified in the configuration file, the import can be run as follows:

\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={Running the data import}}
\begin{lstlisting}
$ java -Xmx3G -classpath /deployed/server-0.1.jar cz.filmtit.dataimport.database.Import configuration.xml
\end{lstlisting}
\vspace*{0.5em}


\subsubsection{Setting up the indexes}

For the imported translation pairs, indexes for fast retrieval are created by running:

\vspace*{0.5em}
\lstset{numbers=none, language=bash, caption={Indexing the imported data}}
\begin{lstlisting}
$ java -Xmx3G -classpath /deployed/server-0.1.jar cz.filmtit.dataimport.database.Reindex configuration.xml
\end{lstlisting}
\vspace*{0.5em}




\section{Configuration}
\label{sec:config}

The configuration for the server is contained in the file \verb#configuration.xml#, which has to be specified on startup.

In this section, we will give a brief overview over the properties specified in the configuration file and its default values.

\subsection{General settings}
L1 and L2 specify the ISO 639-1 codes of the source and target languages used in the translation memory.
\lstset{numbers=none, language=XML, caption={Languages}}
\begin{lstlisting}
<l1>en</l1>
<l2>cs</l2>
\end{lstlisting}

\subsection{Database}

The database connection must be specified as a valid JDBC connector. By default, the DBMS is the local Postgres database \verb#filmtit# with default username and password.

\lstset{numbers=none, language=XML, caption={Database connection}}
\begin{lstlisting}
<database>
    <connector>jdbc:postgresql://localhost/filmtit</connector>
    <user>postgres</user>
    <password>postgres</password>
</database>
\end{lstlisting}

\subsection{Text processing models}

For various text processing tasks within the translation memory, 
it is necessary to specify a number of model files.

The system will search for the models in the folder \verb#model_path#.
\lstset{numbers=none, language=XML, caption={Model path}}
\begin{lstlisting}
<model_path>models/</model_path>
\end{lstlisting}

OpenNLP Maximum Entropy tokenizer models are specified in the \verb#tokenizers# section. If for a specific language, no tokenizer model is specified, the translation memory will use the default OpenNLP WhitespaceTokenizer.
\lstset{numbers=none, language=XML, caption={Tokenizers}, }
\begin{lstlisting}
<tokenizers>
    <tokenizer language="en">en/token.bin</tokenizer>
    <tokenizer language="cs">cs/token.bin</tokenizer>
</tokenizers>
\end{lstlisting}

OpenNLP Maximum Entropy models for Named Entity Recognition are specified in the \verb#ner_models# section. Each \verb#ner_model# specifies a language (ISO 639-1 code) and the type of Entity that it recognizes. Currently, only Person, Place and Organization are used. If fewer models are specified, only the specified models will be used.

\lstset{numbers=none, language=XML, caption={Models for Named Entity Recognition}}
\begin{lstlisting}
<ner_models>
    <!-- English -->
    <ner_model language="en" type="Person">en/ner-person.bin</ner_model>
    <ner_model language="en" type="Place">en/ner-place.bin</ner_model>
    <ner_model language="en" type="Organization">en/ner-organization.bin</ner_model>

    <!-- Czech -->
    <ner_model language="cs" type="Person">cs/ner-person.bin</ner_model>
    <ner_model language="cs" type="Place">cs/ner-place.bin</ner_model>
    <ner_model language="cs" type="Organization">cs/ner-organization.bin</ner_model>
</ner_models>
\end{lstlisting}

\subsection{Data Import}
%TODO section?
For the data import as described in section~\ref{sec:dataimport}, several files have to be specified.

\begin{itemize}
        \item \verb#subtitles_folder# -- the folder containing the subtitle files for the initial import
        \item \verb#data_folder# -- the folder the results of the alignment (see section~\ref{sec:dataimport})
        \item \verb#file_mediasource_mapping# -- a CSV file that describes the source (movie or TV show) of the  subtitle files
        \item \verb#batch_size# -- the number of subtitle files that should be processed at the same time. A higher number will increase the memory consumption of the import process.
        \item \verb#mediasource_cache# -- the location of a cache file for the movie data queried from an external API for each subtitle file
        
\end{itemize}


\lstset{numbers=none, language=XML, caption={Settings for the Data Import}}
\begin{lstlisting}
<import>

    <subtitles_folder>/filmtit/data/export/files/</subtitles_folder>

    <data_folder>/filmtit/data/aligned/</data_folder>
    <file_mediasource_mapping>/filmtit/data/files/export_final.txt</file_mediasource_mapping>
    <batch_size>100</batch_size>
    <mediasource_cache>/filmtit/data/imdb_cache</mediasource_cache>

</import>
\end{lstlisting}


\subsection{Module-Specific Options}

\subsubsection{Core TM}

The module-specific options for the Core TM are mostly related to performance.

\begin{itemize}
        \item \verb#max_number_of_concurrent_searchers# -- specifies the maximum number of searchers that will be created concurrently. By default, 5 searchers will be created and requests will be scheduled among them.
        \item \verb#searcher_timeout# -- specifies the maximum time the scheduler will wait for a searcher to respond. If the time is exceeded, the scheduler will retry a different searcher.
        \item \verb#ranking# -- specifies models used for different rankers, the model files are serialized WEKA classifiers.

\end{itemize}

\lstset{numbers=none, language=XML, caption={Settings for the Core TM}}
\begin{lstlisting}
<core>
    <ranking>
        <exact_ranker_model>ranking/exact.model</exact_ranker_model>
        <fuzzy_ranker_model>ranking/fuzzy.model</fuzzy_ranker_model>
    </ranking>

    <max_number_of_concurrent_searchers>5</max_number_of_concurrent_searchers>
    <searcher_timeout>60</searcher_timeout> <!--in seconds-->

</core>

\end{lstlisting}

\subsubsection{User Space}

User space settings contains few constants influencing the behavior of the application and also fields that need be set correctly to make application running.

\begin{itemize} 
\item \verb#maximum_suggestions_count# -- maximum number of translation suggestions which are displayed to the user for one chunk, users can change this value in their user specific settings
\item \verb#session_timeout_limit# -- time (in milliseconds) after which a user session is terminated if the user does not do any action in case the user did not set up she wants to be logged in permanently
\item \verb#permanent_timeout_limit# -- time (in milliseconds) after which a user session is terminated if the user does not do any action in case the user did set up she wants to be logged in permanently
\item \verb#server_address# -- URL of the web application, it is used in OpenID login to tell the OpenID providers where the browser should be redirected to after logging in
\end{itemize}

\lstset{numbers=none, language=XML, caption={First part of the User Space settings}}
\begin{lstlisting}
<userspace>
     <maximum_suggestions_count>25</maximum_suggestions_count>
     <session_timeout_limit>3600000</session_timeout_limit>
     <permanent_session_timeout_limit>1209600000</permanent_session_timeout_limit>
     <server_address>http://localhost:8080</server_address>
\end{lstlisting}


The second part of the User Space setting concerns sending email from the application. Administrator can set the mailer server, account and text of the messages. Settings needed to establish a connection are listed first.

\begin{itemize}
   \item \verb#mail.transport.protocol# -- protocol for sending
   \item \verb#mail.stmps.port# -- port for sending mail
   \item \verb#mail.stmps.host# -- host server
	\item \verb#mail.smtps.socketFactory.class# -- class used for ssl encryption
	\item \verb#mail.smtps.socketFactory.port# -- port used for ssl
	\item \verb#mail.smtps.auth# -- if connection needs authentication
	\item \verb#mail.filmtit.address# -- account login
	\item \verb#mail.filmtit.password# -- account password
\end{itemize}

Settings of the email subjects and bodies follows. In the registration email body you can use {\tt \%userlogin\%} and {\tt \%userpass\%} templates which are later substituted by the real user name and password values at the time the email is sent. Similarly, {\tt \%userlogin\%} and {\tt \%changeurl\%} templates can be used in the email which is sent to the user when he forgets his password.

\begin{itemize}
\item \verb#mail.filmtit.forgottenPassSubject# -- subject for forgotten password email
\item \verb#mail.filmtit.forgottenPassBody# -- text body for forgotten password email
\item \verb#mail.filmtit.registrationSubject# -- subject for registration email
\item \verb#mail.filmtit.registrationBody# -- text body of registration email
\end{itemize}

\lstset{numbers=none, language=XML, caption={Settings for sending emails, second part of the User Space settings.}}
\begin{lstlisting}
     <mail>
         <properties>
             <comment/>
             <entry key="mail.transport.protocol">smtps</entry>
             <entry key="mail.smtps.port">465</entry>
             <entry key="mail.smtps.host">smtp.gmail.com</entry>
             <entry key="mail.smtps.starttls.enable">true</entry>
             <entry key="mail.smtps.socketFactory.class">javax.net.ssl.SSLSocketFactory</entry>
             <entry key="mail.smtps.socketFactory.port">465</entry>
             <entry key="mail.smtps.auth">true</entry>
             <entry key="mail.filmtit.registrationSubject">Registration on Filmtit</entry>
             <entry key="mail.filmtit.forgottenPassSubject">Request for changing your password on Filmtit</entry>
             <entry key="mail.filmtit.registrationBody">
                 Congratulation,
                 your email address was registered on Filmtit.
                 Your login: %userlogin%
                 Password: %userpass%
             </entry>
             <entry key="mail.filmtit.forgottenPassBody">
                 Hello,
                 there was a request for changing the password
                 for the account: %userlogin%
                 You can change your password by clicking on this link: %changeurl%
             </entry>
             <entry key="mail.filmtit.address">filmtit@gmail.com</entry>
             <entry key="mail.filmtit.password">jkhrjj2012</entry>
         </properties>
     </mail>
</userspace>
\end{lstlisting}


\subsubsection{APIs and keys}

The configuration also specifies the URL of the running Moses instance and the keys for external APIs.

\lstset{numbers=none, language=XML, caption={APIs and keys}}
\begin{lstlisting}
<mosesURL>u-pl17.ms.mff.cuni.cz:8080</mosesURL>
<freebase_key>AIzaSyCBD3hth3xlXTa9FDet4zMiAh0vAjtvbp0</freebase_key>
\end{lstlisting}
